name: ImmortalWrt XGP Build & Release

on:
  workflow_dispatch:
  schedule:
    - cron: '0 18 * * 4'

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      TZ: Asia/Shanghai

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show system info
        run: |
          df -h
          free -h
          nproc

      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 10240
          swap-size-mb: 1024

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ack antlr3 asciidoc autoconf automake autopoint \
            binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl \
            device-tree-compiler ecj fastjar flex gawk gettext \
            gcc-multilib g++-multilib git gnutls-dev gperf \
            haveged help2man intltool \
            lib32gcc-s1 libc6-dev-i386 libelf-dev \
            libglib2.0-dev libgmp3-dev libltdl-dev \
            libmpc-dev libmpfr-dev libncurses-dev \
            libpython3-dev libreadline-dev libssl-dev \
            libtool libyaml-dev libz-dev \
            lld llvm lrzsz mkisofs msmtp nano \
            ninja-build p7zip p7zip-full patch pkgconf \
            python3 python3-pip python3-ply python3-pyelftools \
            qemu-utils re2c rsync scons squashfs-tools \
            subversion swig texinfo uglifyjs upx-ucl \
            unzip vim wget xmlto xxd \
            zlib1g-dev zstd

      - name: Cache dl & staging_dir
        uses: actions/cache@v4
        with:
          path: |
            immortalwrt/dl
            immortalwrt/staging_dir
          key: ${{ runner.os }}-immortalwrt-${{ hashFiles('xgp.config') }}

      - name: Build ImmortalWrt
        shell: bash
        run: |
          set -e

          echo "=== DEBUG: where am I ==="
          pwd
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"

          echo "=== cd to workspace ==="
          cd "$GITHUB_WORKSPACE"

          echo "=== list repo files ==="
          ls -lah

          echo "=== make script executable ==="
          chmod +x build-immortalwrt-gha.sh

          echo "=== run build script ==="
          ./build-immortalwrt-gha.sh

      - name: Run build script
        shell: bash
        run: |
          set -o pipefail
          ./build-immortalwrt-gha.sh 2>&1 | tee build_script.log || true
          # if build log shows error, fail and show first error
          if grep -q -E "error:|^make\\[|^ERROR:" build_script.log; then
            echo ">>> Build had errors â€” first match:"
            grep -n -E "error:|^make\\[|^ERROR:" build_script.log | head -n 1
            exit 1
          fi

      - name: Collect artifacts
        if: success()
        run: |
          mkdir -p release
          cp immortalwrt/bin/targets/rockchip/armv8/*.img.gz release/ 2>/dev/null || true
          cp immortalwrt/bin/targets/rockchip/armv8/*.manifest release/ 2>/dev/null || true
          cp immortalwrt/bin/targets/rockchip/armv8/*.buildinfo release/ 2>/dev/null || true
          cp immortalwrt/bin/targets/rockchip/armv  8/sha256sums release/ 2>/dev/null || true
          ls -lah release || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-xgp-firmware
          path: release/
